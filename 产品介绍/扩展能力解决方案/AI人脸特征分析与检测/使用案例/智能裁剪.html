<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>智能裁剪 | 用心看世界</title>
    <meta name="description" content="技术分享，经验积累，还有生活点滴">
    <script type="text/javascript" src="/scripts/baidu-analytics.js" async=""></script>
    
    <link rel="preload" href="/assets/css/0.styles.84ea2c6c.css" as="style"><link rel="preload" href="/assets/js/app.6fb7da20.js" as="script"><link rel="preload" href="/assets/js/2.6142dfc9.js" as="script"><link rel="preload" href="/assets/js/33.cf9275bc.js" as="script"><link rel="preload" href="/assets/js/3.33c45e77.js" as="script"><link rel="prefetch" href="/assets/js/10.f4280409.js"><link rel="prefetch" href="/assets/js/11.79a32fb2.js"><link rel="prefetch" href="/assets/js/12.8c6343f0.js"><link rel="prefetch" href="/assets/js/13.62c48f17.js"><link rel="prefetch" href="/assets/js/14.77198652.js"><link rel="prefetch" href="/assets/js/15.5ac7f308.js"><link rel="prefetch" href="/assets/js/16.12026611.js"><link rel="prefetch" href="/assets/js/17.089e77d0.js"><link rel="prefetch" href="/assets/js/18.54d04ba8.js"><link rel="prefetch" href="/assets/js/19.836ad4b3.js"><link rel="prefetch" href="/assets/js/20.fd3f5e1f.js"><link rel="prefetch" href="/assets/js/21.1165e8f7.js"><link rel="prefetch" href="/assets/js/22.e82c407c.js"><link rel="prefetch" href="/assets/js/23.7f1edd59.js"><link rel="prefetch" href="/assets/js/24.8e67626f.js"><link rel="prefetch" href="/assets/js/25.3dc222b3.js"><link rel="prefetch" href="/assets/js/26.1f4866fb.js"><link rel="prefetch" href="/assets/js/27.eaed1336.js"><link rel="prefetch" href="/assets/js/28.4e89fe44.js"><link rel="prefetch" href="/assets/js/29.2ff968c9.js"><link rel="prefetch" href="/assets/js/30.eb74f244.js"><link rel="prefetch" href="/assets/js/31.f6807416.js"><link rel="prefetch" href="/assets/js/32.e842209c.js"><link rel="prefetch" href="/assets/js/34.a5c56129.js"><link rel="prefetch" href="/assets/js/35.5a8fd716.js"><link rel="prefetch" href="/assets/js/36.151510f2.js"><link rel="prefetch" href="/assets/js/37.845089ed.js"><link rel="prefetch" href="/assets/js/38.a0ab2c3d.js"><link rel="prefetch" href="/assets/js/39.3a28e750.js"><link rel="prefetch" href="/assets/js/4.18314dd9.js"><link rel="prefetch" href="/assets/js/40.eae3dea9.js"><link rel="prefetch" href="/assets/js/41.67d8eb55.js"><link rel="prefetch" href="/assets/js/42.c32610bb.js"><link rel="prefetch" href="/assets/js/43.269163d0.js"><link rel="prefetch" href="/assets/js/44.f602df58.js"><link rel="prefetch" href="/assets/js/45.69e9ee68.js"><link rel="prefetch" href="/assets/js/46.be5d373e.js"><link rel="prefetch" href="/assets/js/47.74820790.js"><link rel="prefetch" href="/assets/js/48.972655f4.js"><link rel="prefetch" href="/assets/js/49.14dfd7d1.js"><link rel="prefetch" href="/assets/js/5.fb026edc.js"><link rel="prefetch" href="/assets/js/50.c4af4293.js"><link rel="prefetch" href="/assets/js/51.af712aeb.js"><link rel="prefetch" href="/assets/js/52.726183c5.js"><link rel="prefetch" href="/assets/js/53.81d5f918.js"><link rel="prefetch" href="/assets/js/54.715f299e.js"><link rel="prefetch" href="/assets/js/55.befa9746.js"><link rel="prefetch" href="/assets/js/56.7e2045c4.js"><link rel="prefetch" href="/assets/js/57.1c550a68.js"><link rel="prefetch" href="/assets/js/58.0f96a66c.js"><link rel="prefetch" href="/assets/js/59.ebeb8002.js"><link rel="prefetch" href="/assets/js/6.44e2f43d.js"><link rel="prefetch" href="/assets/js/60.0dcf3d11.js"><link rel="prefetch" href="/assets/js/61.c377579d.js"><link rel="prefetch" href="/assets/js/62.275381e6.js"><link rel="prefetch" href="/assets/js/63.ad5d124d.js"><link rel="prefetch" href="/assets/js/64.114daaa7.js"><link rel="prefetch" href="/assets/js/65.6dccde0a.js"><link rel="prefetch" href="/assets/js/66.00dfad51.js"><link rel="prefetch" href="/assets/js/67.47cf09f0.js"><link rel="prefetch" href="/assets/js/68.80e0bd53.js"><link rel="prefetch" href="/assets/js/69.2da7dade.js"><link rel="prefetch" href="/assets/js/7.ccbc20d4.js"><link rel="prefetch" href="/assets/js/70.883ff32d.js"><link rel="prefetch" href="/assets/js/71.d833f1e0.js"><link rel="prefetch" href="/assets/js/72.038ad7c3.js"><link rel="prefetch" href="/assets/js/73.d1f09d78.js"><link rel="prefetch" href="/assets/js/74.f82ddabf.js"><link rel="prefetch" href="/assets/js/75.8dca7e23.js"><link rel="prefetch" href="/assets/js/76.523efa2a.js"><link rel="prefetch" href="/assets/js/77.fc585620.js"><link rel="prefetch" href="/assets/js/78.86110158.js"><link rel="prefetch" href="/assets/js/79.2619ce09.js"><link rel="prefetch" href="/assets/js/8.c6594836.js"><link rel="prefetch" href="/assets/js/80.db09796a.js"><link rel="prefetch" href="/assets/js/81.23178bf4.js"><link rel="prefetch" href="/assets/js/82.de51a556.js"><link rel="prefetch" href="/assets/js/83.78317630.js"><link rel="prefetch" href="/assets/js/84.45d99def.js"><link rel="prefetch" href="/assets/js/85.acaeb320.js"><link rel="prefetch" href="/assets/js/86.5100eb5a.js"><link rel="prefetch" href="/assets/js/87.841a3392.js"><link rel="prefetch" href="/assets/js/88.f9964eb7.js"><link rel="prefetch" href="/assets/js/89.869949ec.js"><link rel="prefetch" href="/assets/js/9.5045e10d.js"><link rel="prefetch" href="/assets/js/90.890269bd.js"><link rel="prefetch" href="/assets/js/91.7caee566.js"><link rel="prefetch" href="/assets/js/92.8fa7bd88.js"><link rel="prefetch" href="/assets/js/93.a16e7b4d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.84ea2c6c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">用心看世界</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link">导航页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">技术分享</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/技术分享/编码规范/前端规范.html" class="nav-link">前端编码规范</a></li></ul></div></div> <a href="https://github.com/shijianzhong" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link">导航页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">技术分享</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/技术分享/编码规范/前端规范.html" class="nav-link">前端编码规范</a></li></ul></div></div> <a href="https://github.com/shijianzhong" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/产品介绍/产品概述.html" class="sidebar-link">产品概述</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基本概念</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/产品介绍/基本概念/Web 端基本概念.html" class="sidebar-link">Web 端基本概念</a></li><li><a href="/产品介绍/基本概念/小程序端基本概念.html" class="sidebar-link">小程序端基本概念</a></li></ul></section></li><li><a href="/产品介绍/应用场景.html" class="sidebar-link">应用场景</a></li><li><a href="/产品介绍/相关产品.html" class="sidebar-link">相关产品</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="智能裁剪"><a href="#智能裁剪" aria-hidden="true" class="header-anchor">#</a> 智能裁剪</h1> <h2 id="体验-demo"><a href="#体验-demo" aria-hidden="true" class="header-anchor">#</a> 体验 demo</h2> <p>选择克隆或下载代码到小程序端 IDE, 更新项目 <code>project.config.json</code> 中的 <code>appid</code> 字段为您的小程序 ID，在当前环境中部署<a href="https://github.com/TencentCloudBase/blog/blob/master/%E4%BA%A7%E5%93%81%E4%BB%8B%E7%BB%8D/%E6%89%A9%E5%B1%95%E8%83%BD%E5%8A%9B%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/AI%E4%BA%BA%E8%84%B8%E7%89%B9%E5%BE%81%E5%88%86%E6%9E%90%E4%B8%8E%E6%A3%80%E6%B5%8B/AI%E4%BA%BA%E8%84%B8%E7%89%B9%E5%BE%81%E5%88%86%E6%9E%90%E4%B8%8E%E6%A3%80%E6%B5%8B%E4%BD%BF%E7%94%A8%E6%8C%87%E5%BC%95.md" target="_blank" rel="noopener noreferrer">部署<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <code>AI 人脸特征分析与检测</code>扩展能力，即可体验智能裁剪小程序。亦可扫码体验线上版本。</p> <p><img src="https://main.qcloudimg.com/raw/c8d4256c25c5645e6f81ddc4ff5e1994.png" alt=""></p> <h3 id="克隆"><a href="#克隆" aria-hidden="true" class="header-anchor">#</a> 克隆</h3> <ol><li>确保您已安装 git 客户端。</li> <li>在命令行中通过以下指令，克隆 demo 仓库：<div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/TencentCloudBase/tcb-demo-ai.git --branch feature/keylessCall
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li>进入 clone 下来的 tcb-demo-ai 目录可见项目代码<div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cd</span> ./tcb-demo-ai
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <h3 id="下载"><a href="#下载" aria-hidden="true" class="header-anchor">#</a> 下载</h3> <p>若无 git 客户端，或其他原因，可以选择手动下载方式：点击<a href="https://github.com//TencentCloudBase/tcb-demo-ai/archive/feature/keylessCall.zip" target="_blank" rel="noopener noreferrer">下载<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>项目代码包，解压到您喜欢的目录。</p> <h2 id="开发"><a href="#开发" aria-hidden="true" class="header-anchor">#</a> 开发</h2> <p>在小程序 IDE 中打开项目，注意更新 <code>project.config.json</code> 中的 <code>appid</code> 字段为您的小程序 ID。</p> <h3 id="目录说明"><a href="#目录说明" aria-hidden="true" class="header-anchor">#</a> 目录说明</h3> <ul><li><code>/client/pages/index</code> - 首页导航目录</li> <li><code>/client/pages/face-detect/clip</code> - 智能裁剪页面入口</li> <li><code>/client/libs/</code> - 依赖库相关</li> <li><ul><li><code>/client/libs/runtime.js</code> - 在某页面引用后，可在该页面使用 <code>async/await</code> 语法，主要用于兼容 <code>iOS</code> 手机</li></ul></li> <li><ul><li><code>/client/libs/weui.wxss</code> - weui 样式文件，在人脸识别组件中有使用，可选。</li></ul></li> <li><ul><li><code>/client/libs/tcb-services-mp-sdk</code> - 小程序中使用的 <code>tcb-services-mp-sdk</code>，封装 tcb 相关公共能力及方法，可选。</li></ul></li></ul> <h3 id="上传图片"><a href="#上传图片" aria-hidden="true" class="header-anchor">#</a> 上传图片</h3> <ol><li><p><a href="https://github.com/TencentCloudBase/tcb-demo-ai/tree/feature/keylessCall/client/pages/face-detect/clip/index.wxml#L8" target="_blank" rel="noopener noreferrer">clip/index.wxml #8<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中上传按钮绑定 <code>tap</code> 事件处理函数 <code>handleUploadTap</code>，点击按钮将触发上传图片操作。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>handleUploadTap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>上传图片<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>在 <a href="https://github.com/TencentCloudBase/tcb-demo-ai/tree/feature/keylessCall/client/pages/face-detect/clip/index.js#L21" target="_blank" rel="noopener noreferrer">clip/index.js #21<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中实现 <code>handleUploadTap</code> 方法。通过调用 <code>wx.chooseImage</code> 选择需要上传的图片，获取到图片对象后，使用云开发存储能力，调用 <a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-client-api/storage/uploadFile.html" target="_blank" rel="noopener noreferrer">wx.cloud.uploadFile<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 将图片上传到云端，在成功回调中获取云端文件对象，拿到 <code>fileID</code> 存储在组件 <code>data</code> 中，同时存储 <code>tempFilePaths</code> 为 <code>temUrl</code> 待用，调用 <code>this.recognize()</code> 进行图片分析（下一步将实现该方法）。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">handleUploadTap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 通过微信 API，选择上传的图片</span>
  wx<span class="token punctuation">.</span><span class="token function">chooseImage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token parameter">dRes</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      wx<span class="token punctuation">.</span><span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        title<span class="token punctuation">:</span> <span class="token string">&quot;上传中&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> fileName <span class="token operator">=</span> dRes<span class="token punctuation">.</span>tempFilePaths<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dotPosition <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> extension <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>dotPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> cloudPath <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>
        Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span>
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extension<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
      <span class="token comment">// 云开发上传图片到云端</span>
      wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        cloudPath<span class="token punctuation">,</span>
        filePath<span class="token punctuation">:</span> dRes<span class="token punctuation">.</span>tempFilePaths<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// 上传成功回调</span>
        <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 将 fileID 存在组件 data 上</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
               temUrl<span class="token punctuation">:</span> dRes<span class="token punctuation">.</span>tempFilePaths<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
               fileID<span class="token punctuation">:</span> res<span class="token punctuation">.</span>fileID<span class="token punctuation">,</span>
               hasUploaded<span class="token punctuation">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
               <span class="token comment">// 图像识别方法，将在下一步实现</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recognize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 上传失败回调，可用于捕获错误，进行提示</span>
        <span class="token function-variable function">fail</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            title<span class="token punctuation">:</span> <span class="token string">&quot;上传失败&quot;</span><span class="token punctuation">,</span>
            icon<span class="token punctuation">:</span> <span class="token string">&quot;none&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div></li></ol> <h3 id="图片分析"><a href="#图片分析" aria-hidden="true" class="header-anchor">#</a> 图片分析</h3> <p>在上一步，我们将一张本地图片上传到云端，并且获取到了云端 fileID，接下来我们将调用云开发扩展能力解决方案 - <code>AI 人脸特征分析与检测</code>，进行图片分析。首先请确保在云开发中部署了 <code>AI 人脸特征分析与检测</code>能力，详见 <a href="https://github.com/TencentCloudBase/blog/blob/master/%E4%BA%A7%E5%93%81%E4%BB%8B%E7%BB%8D/%E6%89%A9%E5%B1%95%E8%83%BD%E5%8A%9B%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/AI%E4%BA%BA%E8%84%B8%E7%89%B9%E5%BE%81%E5%88%86%E6%9E%90%E4%B8%8E%E6%A3%80%E6%B5%8B/AI%E4%BA%BA%E8%84%B8%E7%89%B9%E5%BE%81%E5%88%86%E6%9E%90%E4%B8%8E%E6%A3%80%E6%B5%8B%E4%BD%BF%E7%94%A8%E6%8C%87%E5%BC%95.md" target="_blank" rel="noopener noreferrer">AI 人脸特征分析与检测使用指引<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <ol start="2"><li><p>首先在 <a href="https://github.com/TencentCloudBase/tcb-demo-ai/tree/feature/keylessCall/client/pages/face-detect/clip/index.js" target="_blank" rel="noopener noreferrer">clip/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文件头引入依赖 <code>/client/libs/tcb-services-mp-sdk</code> 与 <code>/client/libs/runtime.js</code>。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> regeneratorRuntime <span class="token keyword">from</span> <span class="token string">&quot;../../../libs/runtime&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> TcbService <span class="token keyword">from</span> <span class="token string">&quot;../../../libs/tcb-service-mp-sdk/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> tcbService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TcbService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>之后实现 <code>recognize</code> 方法。通过 <code>tcbService.callService</code> 方法，传入之前存储于组件 data 中的 <code>fileID</code>，调用 <code>AI 人脸特征分析与检测</code>能力，获取图片识别结果。<code>this.getFaceRect</code> 对识别结果简单处理，获取原图像宽高、人脸相对于图片的位置大小，传递给 <code>this.clip</code> 方法进行裁剪。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token function">recognize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wx<span class="token punctuation">.</span><span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">&quot;识别中&quot;</span><span class="token punctuation">,</span>
    icon<span class="token punctuation">:</span> <span class="token string">&quot;none&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> tcbService<span class="token punctuation">.</span><span class="token function">callService</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      service<span class="token punctuation">:</span> <span class="token string">&quot;ai&quot;</span><span class="token punctuation">,</span>
      action<span class="token punctuation">:</span> <span class="token string">&quot;tcbService-ai-detectFace&quot;</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        FileID<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fileID
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
    或可简单的直接调用云函数
    let result = await wx.cloud.callFunction({
      name: 'tcbService-ai-detectFace',
      data: {
        FileID: this.data.fileID
      }
    });
    **/</span>
    wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>code <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 图像识别成功，结果对象 result.data</span>
      <span class="token keyword">let</span> imgInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFaceRect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>temUrl<span class="token punctuation">,</span> imgInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 识别失败，抛出错误进行错误处理</span>
      <span class="token keyword">throw</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">&quot;识别失败&quot;</span><span class="token punctuation">,</span>
      icon<span class="token punctuation">:</span> <span class="token string">&quot;none&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">getFaceRect</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> ImageWidth<span class="token punctuation">,</span> ImageHeight<span class="token punctuation">,</span> FaceInfos <span class="token punctuation">}</span> <span class="token operator">=</span> res<span class="token punctuation">;</span>
  <span class="token keyword">let</span> face <span class="token operator">=</span> FaceInfos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    imageWidth<span class="token punctuation">:</span> ImageWidth<span class="token punctuation">,</span>
    imageHeight<span class="token punctuation">:</span> ImageHeight<span class="token punctuation">,</span>
    rectX<span class="token punctuation">:</span> face<span class="token punctuation">.</span><span class="token constant">X</span> <span class="token operator">/</span> ImageWidth<span class="token punctuation">,</span>
    rectY<span class="token punctuation">:</span> face<span class="token punctuation">.</span><span class="token constant">Y</span> <span class="token operator">/</span> ImageHeight<span class="token punctuation">,</span>
    rectWidth<span class="token punctuation">:</span> face<span class="token punctuation">.</span>Width <span class="token operator">/</span> ImageWidth<span class="token punctuation">,</span>
    rectHeight<span class="token punctuation">:</span> face<span class="token punctuation">.</span>Height <span class="token operator">/</span> ImageHeight
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div></li></ol> <h3 id="图像裁剪"><a href="#图像裁剪" aria-hidden="true" class="header-anchor">#</a> 图像裁剪</h3> <p>在 <a href="https://github.com/TencentCloudBase/tcb-demo-ai/tree/feature/keylessCall/client/pages/face-detect/clip/index.wxml#L11" target="_blank" rel="noopener noreferrer">clip/index.wxml #11<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中添加画布容器</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>preview-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span>
    <span class="token attr-name"><span class="token namespace">wx:</span>for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{clipSizes}}<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">wx:</span>for-item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>size<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">wx:</span>key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{size[0]/size[1]}}<span class="token punctuation">&quot;</span></span><span class="token style-attr language-css"><span class="token attr-name">
    <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token selector">width:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>size[0]<span class="token punctuation">}</span><span class="token punctuation">}</span>rpx<span class="token selector">; height:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>size[1]<span class="token punctuation">}</span><span class="token punctuation">}</span>rpx<span class="token punctuation">;</span> <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url({{thumb}})</span></span><span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">canvas-id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>canvas-{{size[0]/size[1]}}<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在 <a href="https://github.com/TencentCloudBase/tcb-demo-ai/tree/feature/keylessCall/client/pages/face-detect/clip/index.js#L101" target="_blank" rel="noopener noreferrer">clip/index.js #101<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 实现 <code>clip</code> 方法，使用 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/canvas.html" target="_blank" rel="noopener noreferrer">canvas<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，根据识别信息进行裁剪。基本裁剪策略为：</p> <ol><li>原图等比缩放至接近目标大小，比较原图与目标大小的宽高比，若原图像宽高比较大，则保持高边对齐，缩放至目标大小，反之保持宽边对齐进行缩放。缩放后裁剪窗口可在宽/高方向上进行滑动，选择合适的裁剪位置。</li> <li>根据人脸位置与大小，计算值人脸中心点位置，将人脸中心点在宽/高方向上与裁剪窗口中心对齐，若裁剪窗口超出缩放后图像，则进行平移，直至裁剪窗口刚好落在图像内。</li> <li>使用 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/canvas/CanvasContext.drawImage.html" target="_blank" rel="noopener noreferrer">CanvasContext.drawImage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 将裁剪窗口内的图像绘制于画布中，获取裁剪后图像。（此处需要注意，canvas 的绘制单位为 px，无法根据 rpx 绘制，如果画布设置使用了 rpx，需要进行转换。）</li></ol> <p>示例代码</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 示例采用了 3 种规格的裁剪，</span>
<span class="token comment">// data.clipSizes: [[100, 100], [300, 200], [160, 90]]</span>
<span class="token function">clip</span><span class="token punctuation">(</span> <span class="token parameter">url<span class="token punctuation">,</span> <span class="token punctuation">{</span> imageWidth<span class="token punctuation">,</span> imageHeight<span class="token punctuation">,</span> rectX<span class="token punctuation">,</span> rectWidth<span class="token punctuation">,</span> rectY<span class="token punctuation">,</span> rectHeight <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>clipSizes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>clipWidth<span class="token punctuation">,</span> clipHeight<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> middleWidth <span class="token operator">=</span> rectX <span class="token operator">+</span> rectWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> middleHeight <span class="token operator">=</span> rectY <span class="token operator">+</span> rectHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> clipAspectRatio <span class="token operator">=</span> clipWidth <span class="token operator">/</span> clipHeight<span class="token punctuation">;</span>
    <span class="token keyword">let</span> imageAspectRatio <span class="token operator">=</span> imageWidth <span class="token operator">/</span> imageHeight<span class="token punctuation">;</span>
    <span class="token keyword">let</span> top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
      left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> right <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
      bottom <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>imageAspectRatio <span class="token operator">&lt;</span> clipAspectRatio<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 宽边对齐，上下移动</span>
      <span class="token keyword">let</span> halfHeight <span class="token operator">=</span> imageAspectRatio <span class="token operator">/</span> clipAspectRatio <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
      top <span class="token operator">=</span> middleHeight <span class="token operator">-</span> halfHeight<span class="token punctuation">;</span>
      bottom <span class="token operator">=</span> middleHeight <span class="token operator">+</span> halfHeight<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bottom <span class="token operator">=</span> halfHeight <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bottom <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        top <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> halfHeight <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        bottom <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 高边对齐，左右移动</span>
      <span class="token keyword">let</span> halfWidth <span class="token operator">=</span> clipAspectRatio <span class="token operator">/</span> imageAspectRatio <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
      left <span class="token operator">=</span> middleWidth <span class="token operator">-</span> halfWidth<span class="token punctuation">;</span>
      right <span class="token operator">=</span> middleWidth <span class="token operator">+</span> halfWidth<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        right <span class="token operator">+=</span> <span class="token operator">-</span>left<span class="token punctuation">;</span>
        left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>right <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        left <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> right <span class="token operator">+</span> left<span class="token punctuation">;</span>
        right <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    wx<span class="token punctuation">.</span><span class="token function">getSystemInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取系统屏幕可用宽度，计算缩放大小</span>
        <span class="token keyword">let</span> context <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">createCanvasContext</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`canvas-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>clipAspectRatio<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
          url<span class="token punctuation">,</span>
          Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>left <span class="token operator">*</span> imageWidth<span class="token punctuation">)</span><span class="token punctuation">,</span>
          Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>top <span class="token operator">*</span> imageHeight<span class="token punctuation">)</span><span class="token punctuation">,</span>
          Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>right <span class="token operator">-</span> left<span class="token punctuation">)</span> <span class="token operator">*</span> imageWidth<span class="token punctuation">)</span><span class="token punctuation">,</span>
          Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bottom <span class="token operator">-</span> top<span class="token punctuation">)</span> <span class="token operator">*</span> imageHeight<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token number">0</span><span class="token punctuation">,</span>
          <span class="token number">0</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>res<span class="token punctuation">.</span>windowWidth <span class="token operator">/</span> <span class="token number">750</span><span class="token punctuation">)</span> <span class="token operator">*</span> clipWidth<span class="token punctuation">,</span>
          <span class="token punctuation">(</span>res<span class="token punctuation">.</span>windowWidth <span class="token operator">/</span> <span class="token number">750</span><span class="token punctuation">)</span> <span class="token operator">*</span> clipHeight
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>编译项目，可以实现从文件上传，到人脸识别，再到图片裁剪输出的整个流程。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/shijianzhong/edit/master/产品介绍/扩展能力解决方案/AI人脸特征分析与检测/使用案例/智能裁剪.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">更新于: </span> <span class="time">6/26/2019, 3:53:51 PM</span></div></footer> <!----> </main></div><div class="global-ui"><div></div><div class="my-loader center" style="display:none;" data-v-354e1a9e><div class="my-loader-circle" data-v-354e1a9e></div></div><div class="my-popup" style="display:none;" data-v-6d1057fb><div class="my-popup-container" data-v-6d1057fb><div class="my-popup-exit" data-v-6d1057fb></div> <img src="" alt data-v-6d1057fb></div></div><!----><!----><div></div></div></div>
    <script src="/assets/js/app.6fb7da20.js" defer></script><script src="/assets/js/2.6142dfc9.js" defer></script><script src="/assets/js/33.cf9275bc.js" defer></script><script src="/assets/js/3.33c45e77.js" defer></script>
  </body>
</html>
